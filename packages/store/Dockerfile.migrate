FROM oven/bun:1-slim

WORKDIR /app 

COPY package.json bun.lock ./
COPY apps/api/package.json ./apps/api/
COPY apps/consumer/package.json ./apps/consumer/
COPY apps/fe/package.json ./apps/fe/
COPY apps/producer/package.json ./apps/producer/
COPY apps/tests/package.json ./apps/tests/
COPY packages/eslint-config/package.json ./packages/eslint-config/
COPY packages/redisq/package.json ./packages/redisq/
COPY packages/shared-types/package.json ./packages/shared-types/
COPY packages/store/package.json ./packages/store/
COPY packages/typescript-config/package.json ./packages/typescript-config/

COPY ./packages/store/ ./packages/store/
COPY packages/store/.env .env

RUN apt-get update -y && apt-get install -y openssl
RUN bun install --frozen-lockfile
RUN bunx prisma generate --config=./packages/store/prisma.config.ts

CMD ["bunx", "prisma", "migrate", "deploy"]